#
#  Tasks controller
#
@application.controller 'TasksController', [ 
	'$scope'
	'$routeParams' 
	'FileUploader'
	'CommentProvider'
	'TaskProvider'
	($scope, $routeParams, FileUploader, CommentProvider, TaskProvider) ->
		#
		#  CommentProvider for managing comments
		#
		$scope.Comment = CommentProvider

		#
		#  TaskProvider for managing tasks
		#
		$scope.Task = TaskProvider

		#
		#  Init uploader for file
		#
		$scope.uploader = new FileUploader {
			#
			#  URL for request
			#
			url: '/api/comments' 

			#
			#  Set token
			#
			headers: 
				'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute 'content'

			#
			#  Set date of comment to send data
			#
			onBeforeUploadItem: (item)->
				item.formData.push {
					project_id: $scope.task.project_id
					task_id: $scope.task.id
					title: $scope.comment.title
					comment: $scope.comment.comment
				}

			#
			#  After success add comment push they to task
			#
			onSuccessItem: (item, response, status, headers) ->
				$scope.task.comments.push response
		}

		#
		#  Varaible for store new comment
		#
		$scope.comment = {}

		#
		#  Get current task from db
		#
		$scope.Task.get $routeParams, (data) ->
			#
			#  Set task to scope
			#
			$scope.task = data

			#
			#  Convert deadline to date from string
			#
			$scope.task.deadline = new Date $scope.task.deadline

			#
			#  Cheking action and set date if action EDIT
			#
			if $routeParams.action == 'edit'
				$("#deadline").pickadate('picker').set 'select', $scope.task.deadline

		#
		#  Add comment to db
		#
		$scope.addComment = ->
			$scope.uploader.uploadAll()
]